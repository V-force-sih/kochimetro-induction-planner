<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kochi Metro - Intelligent Operations Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --metro-primary: #0ea5ff;
            --metro-primary-dark: #0a8fe0;
            --metro-secondary: #ffffff;
            --metro-dark: #0b2545;
        }
        body {
            background: linear-gradient(180deg, #f7fbff 0%, #f0f7ff 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--metro-dark);
        }
        .navbar {
            background: linear-gradient(135deg, var(--metro-primary), var(--metro-primary-dark));
            box-shadow: 0 4px 10px rgba(10, 143, 224, 0.12);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(11,37,69,0.04);
            margin-bottom: 20px;
            border: none;
            background: #ffffff;
        }
        .card-header {
            background: transparent;
            color: var(--metro-dark);
            border-radius: 10px 10px 0 0 !important;
        }
        .btn-metro {
            background: var(--metro-primary);
            border: none;
            color: var(--metro-secondary);
            font-weight: bold;
        }
        .btn-metro:hover {
            background: var(--metro-primary-dark);
        }
        .btn-schedule {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-weight: bold;
        }
        .btn-schedule:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            color: white;
        }
        .train-operational-card {
            transition: all 0.3s ease;
            border-left: 4px solid #4a86e8;
        }
        .train-operational-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .health-score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .maintenance-timeline {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #4a86e8;
        }
        .operational-metrics {
            background: #f0f7ff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .progress {
            background-color: #e9ecef;
            border-radius: 3px;
        }
        .service-badge {
            background-color: #e6faff;
            color: var(--metro-primary);
            padding: 6px 10px;
            border-radius: 6px;
            font-weight:700;
        }
        .standby-badge {
            background-color: #fff7e6;
            color: #b36b00;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight:700;
        }
        .ibl-badge {
            background-color: #fff0f4;
            color: #d6334f;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight:700;
        }
        .stats-card {
            text-align: center;
            padding: 15px;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }
        #optimizationResults {
            display: none;
        }
        .depot-zone {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin: 5px;
            flex: 1;
        }
        .movement-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            vertical-align: middle;
        }
        .no-movement {
            background-color: #b8f1d3;
        }
        .low-movement {
            background-color: #ffe9b3;
        }
        .high-movement {
            background-color: #ffb3c7;
        }
        .override-badge {
            background-color: #7c9cff;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight:700;
        }
        .overrides-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .debug-panel {
            font-family: monospace;
            font-size: 0.85rem;
            background: #fbfcff;
            padding: 8px;
            border-radius: 6px;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .conflict-card {
            border-left: 4px solid #ff6b6b;
            background: linear-gradient(90deg, rgba(255,235,235,0.9), rgba(255,250,240,0.9));
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .explanation-list { padding-left: 16px; margin-top: 6px; color: #123; }
        .branding-control { display:flex; gap:8px; align-items:center; }
        .branding-control input[type="number"] { max-width: 140px; }
        .ml-recommendation { 
            background: #f8f9ff; 
            border-left: 4px solid var(--metro-primary); 
            padding: 10px; 
            margin-bottom: 10px; 
            border-radius: 4px; 
        }
        .ml-confidence { 
            font-size: 0.85rem; 
            color: #666; 
            margin-top: 5px; 
        }
        .health-score-gauge {
            width: 100px;
            height: 100px;
            position: relative;
            margin: 0 auto 15px;
        }
        .health-score-gauge circle {
            fill: none;
            stroke-width: 10;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .health-score-gauge .gauge-bg {
            stroke: #e9ecef;
        }
        .health-score-gauge .gauge-value {
            stroke: #4a86e8;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }
        .health-score-gauge .gauge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 1.5rem;
        }
        .component-health {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .component-health .component {
            text-align: center;
            flex: 1;
        }
        .component-health .component-name {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 5px;
        }
        .component-health .component-value {
            font-weight: bold;
            font-size: 0.9rem;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .button-group .btn {
            flex: 1;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <!-- Toast notifications -->
    <div class="toast-container"></div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-subway me-2"></i>
                Kochi Metro - Intelligent Operations Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="scheduled.html" style="color: white;">
                    <i class="fas fa-calendar-alt me-1"></i>View Schedule
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Control Panel -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Optimization Control Panel</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="trainsRequired" class="form-label">Trains Required for Service</label>
                            <input type="number" class="form-control" id="trainsRequired" value="20" min="1" max="30">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Resources Available</label>
                            <div class="d-flex justify-content-between">
                                <span class="badge" style="background:#e6f8ff; color:var(--metro-primary);">IBL Capacity: 5 slots</span>
                                <span class="badge" style="background:#eef9ff; color:var(--metro-primary);">Cleaning Slots: 4</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Branding quota toggle + number input -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label class="form-label">Branding Quota (demo)</label>
                        <div class="branding-control">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="brandingQuotaToggle">
                                <label class="form-check-label" for="brandingQuotaToggle">Enforce minimum total branding exposure</label>
                            </div>
                            <input type="number" id="brandingMinTotal" class="form-control" placeholder="branding_min_total" min="0" step="1" value="" title="Enter total branding_priority target (e.g., 50)">
                            <small class="text-muted">If enabled, this value will be sent to the backend as <code>branding_min_total</code>.</small>
                        </div>
                    </div>
                </div>

                <!-- Button Group for Optimization and Schedule -->
                <div class="button-group">
                    <button id="runOptimization" class="btn btn-metro btn-lg">
                        <i class="fas fa-bolt me-2"></i>Run Optimization
                    </button>
                    <button id="viewSchedule" class="btn btn-schedule btn-lg">
                        <i class="fas fa-calendar-alt me-2"></i>Sample Schedule Optimal
                    </button>
                </div>
            </div>
        </div>

        <!-- Rest of your existing code remains the same -->
        <!-- ML Insights Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-brain me-2"></i>ML Insights</h5>
            </div>
            <div class="card-body">
                <div id="mlInsights">
                    <p class="text-muted">Run optimization to see ML recommendations</p>
                </div>
                <div class="mt-3">
                    <button id="retrainModel" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-robot me-1"></i>Retrain ML Model
                    </button>
                </div>
            </div>
        </div>

        <!-- Override Control Panel -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Override Controls</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="overrideTrainId" class="form-label">Train ID</label>
                            <input type="text" class="form-control" id="overrideTrainId" placeholder="Enter Train ID (e.g., T01)">
                        </div>
                        <div class="mb-3">
                            <label for="overrideAction" class="form-label">Action</label>
                            <select class="form-select" id="overrideAction">
                                <option value="service">Service</option>
                                <option value="standby">Standby</option>
                                <option value="ibl">IBL</option>
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="overrideForce">
                            <label class="form-check-label" for="overrideForce">
                                Force Override
                            </label>
                        </div>
                        <button id="setOverride" class="btn btn-metro w-100">
                            <i class="fas fa-exclamation-circle me-2"></i>Set Override
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h5>Current Overrides</h5>
                        <div class="overrides-list" id="currentOverrides">
                            <p class="text-muted">No overrides set. Click "Load Overrides" to refresh.</p>
                        </div>
                        <button id="loadOverrides" class="btn btn-outline-primary mt-3 w-100">
                            <i class="fas fa-sync-alt me-2"></i>Load Overrides
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Panel (initially hidden) -->
        <div class="card mt-4" id="debugPanel" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bug me-2"></i>Debug Information
                    <button id="toggleDebug" class="btn btn-sm btn-outline-light float-end">Hide</button>
                </h5>
            </div>
            <div class="card-body debug-panel">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Last API Request</h6>
                        <pre id="lastRequest">No requests yet</pre>
                    </div>
                    <div class="col-md-6">
                        <h6>Last API Response</h6>
                        <pre id="lastResponse">No responses yet</pre>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Connection Status</h6>
                    <div id="connectionStatus" class="badge bg-success">Checking...</div>
                    <button id="testConnection" class="btn btn-sm btn-outline-primary ms-2">
                        Test Connection
                    </button>
                </div>
            </div>
        </div>

        <!-- Show Debug Button -->
        <div class="text-center mt-3">
            <button id="showDebug" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-bug me-1"></i>Show Debug Panel
            </button>
        </div>

        <!-- Results Section -->
        <div id="optimizationResults" class="card" style="display:none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Optimization Results</h5>
            </div>
            <div class="card-body">
                <!-- Conflicts container -->
                <div id="conflictsContainer" style="display:none;" class="conflict-card">
                    <h6 class="mb-2">âš  Warnings / Conflicts</h6>
                    <ul id="conflictList" class="mb-0"></ul>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card stats-card">
                            <div class="stats-number" id="serviceCount">0</div>
                            <div>Service Trains</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stats-card">
                            <div class="stats-number" id="standbyCount">0</div>
                            <div>Standby Trains</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card stats-card">
                            <div class="stats-number" id="iblCount">0</div>
                            <div>IBL Trains</div>
                        </div>
                    </div>
                </div>

                <!-- Stabling Optimization Section -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Stabling Optimization</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Stabling Movement Summary</h6>
                                <div id="stablingSummary">
                                    <p>Total movement cost: <span id="totalMovementCost">0</span> units</p>
                                    <p>Trains requiring movement: <span id="trainsMoved">0</span></p>
                                    <div class="mt-3">
                                        <h6>Movement Legend</h6>
                                        <div><span class="movement-indicator no-movement"></span> No movement needed</div>
                                        <div><span class="movement-indicator low-movement"></span> Low cost movement</div>
                                        <div><span class="movement-indicator high-movement"></span> High cost movement</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Depot Layout</h6>
                                <div id="depotVisualization" style="height: 200px; background: #f0f8ff; border-radius: 5px; display: flex; justify-content: space-around; align-items: center; padding: 10px;">
                                    <div class="depot-zone" style="background: #e6faff; color: var(--metro-primary);">Service Zone<br>(A-W bays)</div>
                                    <div class="depot-zone" style="background: #fff7e6; color: #b36b00;">Standby Zone<br>(STB bays)</div>
                                    <div class="depot-zone" style="background: #fff0f4; color: #d6334f;">IBL Zone<br>(IBL bays)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <ul class="nav nav-tabs mt-4" id="resultsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="service-tab" data-bs-toggle="tab" data-bs-target="#service" type="button" role="tab">Service Trains</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="standby-tab" data-bs-toggle="tab" data-bs-target="#standby" type="button" role="tab">Standby Trains</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ibl-tab" data-bs-toggle="tab" data-bs-target="#ibl" type="button" role="tab">IBL Trains</button>
                    </li>
                </ul>

                <div class="tab-content p-3 border border-top-0" id="resultsTabContent">
                    <div class="tab-pane fade show active" id="service" role="tabpanel">
                        <div id="serviceTrains" class="row"></div>
                    </div>
                    <div class="tab-pane fade" id="standby" role="tabpanel">
                        <div id="standbyTrains" class="row"></div>
                    </div>
                    <div class="tab-pane fade" id="ibl" role="tabpanel">
                        <div id="iblTrains" class="row"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Keep originalTrainData shape same as before
        let originalTrainData = [];

        function getApiBase() {
            return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:8000'
                : 'https://your-deployed-api-url.com';
        }

        // Health Score Calculation System
        function calculateHealthScore(train) {
            let score = 100; // Start with perfect score
            
            // Deduct points based on various factors
            if (train.job_cards.open_critical > 0) score -= 30;
            if (train.job_cards.open_non_critical > 0) score -= 10;
            
            // Mileage-based deductions (higher mileage = more wear)
            const mileageDeduction = Math.min(15, (train.mileage - 50000) / 10000);
            score -= mileageDeduction;
            
            // Fitness certificate deductions
            if (!train.fitness_certificates.rolling_stock) score -= 25;
            if (!train.fitness_certificates.signalling) score -= 25;
            if (!train.fitness_certificates.telecom) score -= 25;
            
            // Cleaning requirement deduction
            if (train.requires_cleaning) score -= 5;
            
            return Math.max(0, Math.round(score)); // Ensure score is between 0-100
        }

        function getHealthStatus(score) {
            if (score >= 90) return { label: 'Excellent', class: 'success' };
            if (score >= 75) return { label: 'Good', class: 'info' };
            if (score >= 60) return { label: 'Fair', class: 'warning' };
            return { label: 'Poor', class: 'danger' };
        }

        // Predictive Maintenance Calculations
        function calculateMaintenanceMetrics(train) {
            const baseDate = new Date('2023-10-01'); // Current date
            const lastMaintenance = new Date(train.last_maintenance_date);
            
            // Calculate days since last maintenance
            const daysSinceMaintenance = Math.floor((baseDate - lastMaintenance) / (1000 * 60 * 60 * 24));
            
            // Predict next service (every 180 days)
            const nextServiceDue = new Date(lastMaintenance);
            nextServiceDue.setDate(nextServiceDue.getDate() + 180);
            
            // Calculate component wear (simulated)
            const brakePadWear = Math.min(100, Math.round((train.mileage % 50000) / 500));
            const hvacEfficiency = Math.max(40, 100 - Math.round((train.mileage % 100000) / 2000));
            
            // Calculate monthly average mileage
            const serviceDate = new Date(train.last_maintenance_date || '2023-01-01');
            const monthsInService = Math.max(1, (baseDate - serviceDate) / (1000 * 60 * 60 * 24 * 30));
            const avgMonthlyMileage = Math.round(train.mileage / monthsInService);
            
            // Calculate branding hours (simulated based on usage pattern)
            const brandingHours = Math.round(train.branding_priority * 12.5 + Math.random() * 20);
            
            return {
                healthScore: calculateHealthScore(train),
                nextServiceDue: nextServiceDue.toISOString().split('T')[0],
                brakePadWear: brakePadWear,
                hvacEfficiency: hvacEfficiency,
                avgMonthlyMileage: avgMonthlyMileage,
                brandingHours: brandingHours,
                stablingEfficiency: calculateStablingEfficiency(train.current_stable_position)
            };
        }

        function calculateStablingEfficiency(position) {
            // Analyze position for optimal stabling
            if (position.includes('A') || position.includes('B') || position.includes('C')) {
                return { label: 'Optimal', score: 90 };
            } else if (position.includes('STB') || position.includes('IBL')) {
                return { label: 'Service Ready', score: 75 };
            } else {
                return { label: 'Remote', score: 60 };
            }
        }

        function getFitnessBadgeColor(train) {
            const certs = train.fitness_certificates || {};
            return certs.rolling_stock && certs.signalling && certs.telecom ? 'success' : 'danger';
        }

        function getFitnessStatusText(train) {
            const certs = train.fitness_certificates || {};
            return certs.rolling_stock && certs.signalling && certs.telecom ? 'Valid' : 'Invalid';
        }

        // Create health score gauge SVG
        function createHealthScoreGauge(score) {
            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (score / 100) * circumference;
            
            return `
                <svg class="health-score-gauge" viewBox="0 0 100 100">
                    <circle class="gauge-bg" cx="50" cy="50" r="${radius}" stroke-width="10"></circle>
                    <circle class="gauge-value" cx="50" cy="50" r="${radius}" stroke-width="10" 
                            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"></circle>
                    <text class="gauge-text" x="50" y="50" text-anchor="middle" dy=".3em">${score}</text>
                </svg>
            `;
        }

        // Show toast notifications
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 3500 });
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        // Log API calls for debugging
        function safeParseBody(body) {
            if (!body) return null;
            try { return JSON.parse(body); } catch (e) { return body; }
        }
        
        function logApiCall(url, options, response, data) {
            try {
                const requestLog = {
                    url,
                    method: options?.method || 'GET',
                    headers: options?.headers || {},
                    body: safeParseBody(options?.body)
                };
                document.getElementById('lastRequest').textContent = JSON.stringify(requestLog, null, 2);
                document.getElementById('lastResponse').textContent = JSON.stringify({
                    status: response?.status || 'N/A',
                    statusText: response?.statusText || '',
                    data: data || null
                }, null, 2);
            } catch (e) { /* non-fatal logging error */ console.warn('logApiCall failed', e); }
        }

        // Test API connection
        async function testConnection() {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = 'badge bg-secondary';
            statusElement.textContent = 'Testing...';

            try {
                const API_BASE = getApiBase();
                const response = await fetch(`${API_BASE}/trains`);

                if (response.ok) {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = 'Connected';
                    showToast('API connection successful', 'success');
                } else {
                    statusElement.className = 'badge bg-warning';
                    statusElement.textContent = `Error: ${response.status}`;
                    showToast(`API connection error: ${response.status}`, 'warning');
                }
            } catch (error) {
                statusElement.className = 'badge bg-danger';
                statusElement.textContent = 'Failed';
                showToast(`API connection failed: ${error.message}`, 'danger');
            }
        }

        // Load train data
        async function loadTrainData() {
            try {
                const API_BASE = getApiBase();
                const response = await fetch(`${API_BASE}/trains`);
                const data = await response.json();
                logApiCall(`${API_BASE}/trains`, { method: 'GET' }, response, data);

                if (data.status === 'success') {
                    originalTrainData = data.data;
                    console.log('Loaded train data:', originalTrainData.length, 'trains');
                    showToast(`Loaded data for ${originalTrainData.length} trains`, 'success');
                } else {
                    console.error('Failed to load train data');
                    showToast('Failed to load train data', 'danger');
                }
            } catch (error) {
                console.error('Error loading train data:', error);
                showToast(`Error loading train data: ${error.message}`, 'danger');
            }
        }

        // Load overrides
        async function loadOverrides() {
            try {
                const API_BASE = getApiBase();
                const response = await fetch(`${API_BASE}/overrides`);
                const data = await response.json();
                logApiCall(`${API_BASE}/overrides`, { method: 'GET' }, response, data);

                const overridesContainer = document.getElementById('currentOverrides');
                overridesContainer.innerHTML = '';

                if (data.overrides && data.overrides.length > 0) {
                    data.overrides.forEach(override => {
                        const overrideElement = document.createElement('div');
                        overrideElement.className = 'card mb-2 p-2';
                        overrideElement.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="override-badge">${override.train_id}</span>
                                    <span class="badge ms-2 ${getBadgeClassForAction(override.action)}">${override.action.toUpperCase()}</span>
                                    <small class="text-muted ms-2">${override.force ? 'Forced' : 'Normal'}</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger remove-override" data-train-id="${override.train_id}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        overridesContainer.appendChild(overrideElement);
                    });

                    // Attach listeners for remove buttons
                    document.querySelectorAll('.remove-override').forEach(button => {
                        button.addEventListener('click', function() {
                            const trainId = this.getAttribute('data-train-id');
                            removeOverride(trainId);
                        });
                    });

                    showToast(`Loaded ${data.overrides.length} overrides`, 'success');
                } else {
                    overridesContainer.innerHTML = '<p class="text-muted">No overrides currently set.</p>';
                    showToast('No overrides found', 'info');
                }
            } catch (error) {
                console.error('Error loading overrides:', error);
                document.getElementById('currentOverrides').innerHTML = '<p class="text-danger">Error loading overrides</p>';
                showToast(`Error loading overrides: ${error.message}`, 'danger');
            }
        }

        // Set override
        async function setOverride() {
            const trainId = document.getElementById('overrideTrainId').value.trim();
            const action = document.getElementById('overrideAction').value;
            const force = document.getElementById('overrideForce').checked;

            if (!trainId) { showToast('Please enter a Train ID', 'warning'); return; }

            const btn = document.getElementById('setOverride');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Setting Override...';
            btn.disabled = true;

            try {
                const API_BASE = getApiBase();
                const requestBody = JSON.stringify({ train_id: trainId, action: action, force: force });

                const response = await fetch(`${API_BASE}/override`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: requestBody
                });

                let data;
                try { data = await response.json(); } catch (e) { throw new Error(`Invalid JSON response: ${await response.text()}`); }

                logApiCall(`${API_BASE}/override`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: requestBody }, response, data);

                if (data.status === 'success') {
                    showToast(`Override set successfully for train ${trainId}`, 'success');
                    document.getElementById('overrideTrainId').value = '';
                    document.getElementById('overrideForce').checked = false;
                    loadOverrides();
                } else {
                    showToast('Error: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Error setting override:', error);
                showToast(`Error setting override: ${error.message}`, 'danger');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Remove override
        async function removeOverride(trainId) {
            try {
                const API_BASE = getApiBase();
                const response = await fetch(`${API_BASE}/override/${encodeURIComponent(trainId)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                logApiCall(`${API_BASE}/override/${trainId}`, { method: 'DELETE' }, response, data);

                if (data.status === 'success') {
                    showToast(`Override removed successfully for train ${trainId}`, 'success');
                    loadOverrides();
                } else {
                    showToast('Error: ' + (data.message || 'Failed to remove override'), 'danger');
                }
            } catch (error) {
                console.error('Error removing override:', error);
                showToast(`Error removing override: ${error.message}`, 'danger');
            }
        }

        function getBadgeClassForAction(action) {
            switch(action) {
                case 'service': return 'bg-success';
                case 'standby': return 'bg-warning text-dark';
                case 'ibl': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // Determine zone from position
        function getZoneFromPosition(position) {
            if (!position) return "Unknown";
            if (position.includes("STB")) return "Standby";
            if (position.includes("IBL")) return "IBL";
            const firstChar = position.charAt(0);
            if (firstChar >= 'A' && firstChar <= 'W') return "Service";
            return "Unknown";
        }

        // Movement cost function
        function getMovementCost(fromZone, toZone) {
            const costMatrix = {
                "Service": {"Service": 0, "Standby": 2, "IBL": 3, "Unknown": 3},
                "Standby": {"Service": 2, "Standby": 0, "IBL": 1, "Unknown": 3},
                "IBL": {"Service": 3, "Standby": 1, "IBL": 0, "Unknown": 3},
                "Unknown": {"Service": 3, "Standby": 3, "IBL": 3, "Unknown": 3}
            };
            return costMatrix[fromZone] ? (costMatrix[fromZone][toZone] || 3) : 3;
        }

        // Calculate stabling info
        function calculateStablingInfo(solution) {
            let movementCost = 0;
            let trainsMoved = 0;
            const movementDetails = [];

            solution.service.forEach(train => {
                const originalTrain = originalTrainData.find(t => t.id === train.id);
                if (originalTrain) {
                    const fromZone = getZoneFromPosition(originalTrain.current_stable_position);
                    const toZone = "Service";
                    const cost = getMovementCost(fromZone, toZone);

                    if (cost > 0) {
                        movementCost += cost;
                        trainsMoved++;
                        movementDetails.push({
                            trainId: train.id,
                            from: originalTrain.current_stable_position,
                            to: "Service",
                            cost: cost
                        });
                    }
                }
            });

            solution.standby.forEach(train => {
                const originalTrain = originalTrainData.find(t => t.id === train.id);
                if (originalTrain) {
                    const fromZone = getZoneFromPosition(originalTrain.current_stable_position);
                    const toZone = "Standby";
                    const cost = getMovementCost(fromZone, toZone);

                    if (cost > 0) {
                        movementCost += cost;
                        trainsMoved++;
                        movementDetails.push({
                            trainId: train.id,
                            from: originalTrain.current_stable_position,
                            to: "Standby",
                            cost: cost
                        });
                    }
                }
            });

            solution.ibl.forEach(train => {
                const originalTrain = originalTrainData.find(t => t.id === train.id);
                if (originalTrain) {
                    const fromZone = getZoneFromPosition(originalTrain.current_stable_position);
                    const toZone = "IBL";
                    const cost = getMovementCost(fromZone, toZone);

                    if (cost > 0) {
                        movementCost += cost;
                        trainsMoved++;
                        movementDetails.push({
                            trainId: train.id,
                            from: originalTrain.current_stable_position,
                            to: "IBL",
                            cost: cost
                        });
                    }
                }
            });

            return { movementCost, trainsMoved, movementDetails };
        }

        // ML Insights functionality
        function updateMLInsights(solution, explanations = {}) {
            const mlInsightsContainer = document.getElementById('mlInsights');
            
            if (!solution || Object.keys(solution).length === 0) {
                mlInsightsContainer.innerHTML = '<p class="text-muted">Run optimization to see ML recommendations</p>';
                return;
            }

            // Generate ML insights based on the solution
            let insightsHTML = '';
            
            // Analyze service trains for branding optimization
            const highBrandingTrains = solution.service.filter(train => train.branding_priority >= 8);
            if (highBrandingTrains.length > 0) {
                insightsHTML += `
                <div class="ml-recommendation">
                    <strong>ðŸ“Š Branding Optimization</strong>
                    <p>${highBrandingTrains.length} high-branding trains in service (priority â‰¥8)</p>
                    <div class="ml-confidence">Maximizes advertising revenue potential</div>
                </div>
                `;
            }

            // Analyze maintenance patterns
            const highMileageTrains = solution.service.filter(train => train.mileage > 80000);
            if (highMileageTrains.length > 0) {
                insightsHTML += `
                <div class="ml-recommendation">
                    <strong>ðŸ”§ Maintenance Planning</strong>
                    <p>${highMileageTrains.length} high-mileage trains in service (>80,000 km)</p>
                    <div class="ml-confidence">Consider scheduling maintenance in next cycle</div>
                </div>
                `;
            }

            // Analyze IBL assignments
            const criticalIBLTrains = solution.ibl.filter(train => train.job_cards.open_critical >= 3);
            if (criticalIBLTrains.length > 0) {
                insightsHTML += `
                <div class="ml-recommendation">
                    <strong>âš  Critical Maintenance</strong>
                    <p>${criticalIBLTrains.length} trains in IBL with 3+ critical job cards</p>
                    <div class="ml-confidence">Prioritize these for immediate attention</div>
                </div>
                `;
            }

            // Resource utilization insights
            const utilizationRate = Math.round((solution.service.length / parseInt(document.getElementById('trainsRequired').value || "20")) * 100);
            insightsHTML += `
            <div class="ml-recommendation">
                <strong>ðŸ“ˆ Resource Utilization</strong>
                <p>Service utilization: ${utilizationRate}% (${solution.service.length}/${document.getElementById('trainsRequired').value || "20"} trains)</p>
                <div class="ml-confidence">${utilizationRate > 90 ? 'Optimal' : utilizationRate > 70 ? 'Good' : 'Could be improved'}</div>
            </div>
            `;

            mlInsightsContainer.innerHTML = insightsHTML || '<p class="text-muted">No specific ML insights for this optimization run</p>';
        }

        // Retrain ML Model function
        async function retrainMLModel() {
            const btn = document.getElementById('retrainModel');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Retraining...';
            btn.disabled = true;

            try {
                const API_BASE = getApiBase();
                const response = await fetch(`${API_BASE}/retrain-model`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast('ML model retrained successfully', 'success');
                } else {
                    showToast('Model retraining failed: ' + (data.message || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error retraining model:', error);
                showToast('Model retraining endpoint not available', 'info');
            } finally {
                btn.innerHTML = '<i class="fas fa-robot me-1"></i>Retrain ML Model';
                btn.disabled = false;
            }
        }

        // Display intelligent train cards
        function displayIntelligentTrainCards(solution, explanations = {}, conflicts = null) {
            // Update counts
            document.getElementById('serviceCount').textContent = solution.service.length;
            document.getElementById('standbyCount').textContent = solution.standby.length;
            document.getElementById('iblCount').textContent = solution.ibl.length;

            // Stabling info
            const stablingInfo = calculateStablingInfo(solution);
            document.getElementById('totalMovementCost').textContent = stablingInfo.movementCost;
            document.getElementById('trainsMoved').textContent = stablingInfo.trainsMoved;

            // Conflicts - FIXED: Handle both conflict_alert (old) and conflict (new)
            const conflictsContainer = document.getElementById('conflictsContainer');
            const conflictList = document.getElementById('conflictList');
            conflictList.innerHTML = '';
            
            // Handle conflicts - check both possible field names
            let conflictMessages = [];
            if (conflicts) {
                if (Array.isArray(conflicts)) {
                    conflictMessages = conflicts;
                } else if (typeof conflicts === 'string') {
                    conflictMessages = [conflicts];
                }
            }
            
            if (conflictMessages.length > 0) {
                conflictMessages.forEach(msg => {
                    const li = document.createElement('li');
                    li.textContent = msg;
                    conflictList.appendChild(li);
                });
                conflictsContainer.style.display = 'block';
            } else {
                conflictsContainer.style.display = 'none';
            }

            // Render service trains with intelligent cards
            const serviceContainer = document.getElementById('serviceTrains');
            serviceContainer.innerHTML = solution.service.map(train => {
                const metrics = calculateMaintenanceMetrics(train);
                const healthStatus = getHealthStatus(metrics.healthScore);
                const stablingInfo = calculateStablingEfficiency(train.current_stable_position);
                const originalTrain = originalTrainData.find(t => t.id === train.id);
                const fromZone = originalTrain ? getZoneFromPosition(originalTrain.current_stable_position) : "Unknown";
                const cost = getMovementCost(fromZone, "Service");
                let movementClass = "no-movement";
                if (cost === 2) movementClass = "low-movement";
                else if (cost >= 3) movementClass = "high-movement";

                // explanation HTML (if present)
                const expl = Array.isArray(explanations[train.id]) ? explanations[train.id] : (explanations[train.id] ? [explanations[train.id]] : []);
                const explHtml = expl.length ? `<details><summary>Explanation</summary><ul class="explanation-list">${expl.map(e => `<li>${e}</li>`).join('')}</ul></details>` : '';

                return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card train-operational-card">
                        <div class="card-header bg-transparent border-bottom-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Train #${train.id.replace('T', '')}</h5>
                                <span class="badge bg-${healthStatus.class}">${metrics.healthScore}</span>
                            </div>
                            <small class="text-muted">Health Score â€¢ ${healthStatus.label}</small>
                        </div>
                        <div class="card-body">
                            <!-- Health & Service Status -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Service</small>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-success me-2">Active</span>
                                        <span class="movement-indicator ${movementClass}" title="Movement cost: ${cost}"></span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Certification</small>
                                    <div>
                                        <span class="badge bg-${getFitnessBadgeColor(train)}">${getFitnessStatusText(train)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Main Health Score -->
                            <div class="text-center mb-3">
                                ${createHealthScoreGauge(metrics.healthScore)}
                                <small class="text-muted">Overall Health Score</small>
                            </div>
                            
                            <!-- Maintenance Timeline -->
                            <div class="maintenance-timeline mb-3">
                                <div class="d-flex justify-content-between small text-muted">
                                    <span>Cert. Expiry:<br><strong>2025-11-24</strong></span>
                                    <span>Next Service:<br><strong>${metrics.nextServiceDue}</strong></span>
                                </div>
                            </div>
                            
                            <!-- Component Health -->
                            <div class="component-health">
                                <div class="component">
                                    <div class="component-name">Brake Wear</div>
                                    <div class="component-value">${metrics.brakePadWear}%</div>
                                    <div class="progress" style="height: 4px; width: 40px; margin: 0 auto;">
                                        <div class="progress-bar bg-warning" style="width: ${metrics.brakePadWear}%"></div>
                                    </div>
                                </div>
                                <div class="component">
                                    <div class="component-name">HVAC</div>
                                    <div class="component-value">${metrics.hvacEfficiency}%</div>
                                    <div class="progress" style="height: 4px; width: 40px; margin: 0 auto;">
                                        <div class="progress-bar bg-info" style="width: ${metrics.hvacEfficiency}%"></div>
                                    </div>
                                </div>
                                <div class="component">
                                    <div class="component-name">Stabling</div>
                                    <div class="component-value">${stablingInfo.score}</div>
                                    <div class="progress" style="height: 4px; width: 40px; margin: 0 auto;">
                                        <div class="progress-bar bg-primary" style="width: ${stablingInfo.score}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Operational Metrics -->
                            <div class="operational-metrics">
                                <div class="row small">
                                    <div class="col-6">
                                        <span class="text-muted">Total Mileage:</span><br>
                                        <strong>${train.mileage.toLocaleString()} km</strong>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted">Avg. Monthly:</span><br>
                                        <strong>${metrics.avgMonthlyMileage.toLocaleString()} km</strong>
                                    </div>
                                </div>
                                <div class="row small mt-2">
                                    <div class="col-6">
                                        <span class="text-muted">Branding Hours:</span><br>
                                        <strong>${metrics.brandingHours} hrs</strong>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted">Stabling:</span><br>
                                        <strong>${train.current_stable_position}</strong>
                                    </div>
                                </div>
                            </div>
                            ${explHtml}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // Render standby trains
            const standbyContainer = document.getElementById('standbyTrains');
            standbyContainer.innerHTML = solution.standby.map(train => {
                const metrics = calculateMaintenanceMetrics(train);
                const healthStatus = getHealthStatus(metrics.healthScore);
                const originalTrain = originalTrainData.find(t => t.id === train.id);
                const fromZone = originalTrain ? getZoneFromPosition(originalTrain.current_stable_position) : "Unknown";
                const cost = getMovementCost(fromZone, "Standby");
                let movementClass = "no-movement";
                if (cost === 2) movementClass = "low-movement";
                else if (cost >= 3) movementClass = "high-movement";

                const expl = Array.isArray(explanations[train.id]) ? explanations[train.id] : (explanations[train.id] ? [explanations[train.id]] : []);
                const explHtml = expl.length ? `<details><summary>Explanation</summary><ul class="explanation-list">${expl.map(e => `<li>${e}</li>`).join('')}</ul></details>` : '';

                return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card train-operational-card">
                        <div class="card-header bg-transparent border-bottom-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Train #${train.id.replace('T', '')}</h5>
                                <span class="badge bg-${healthStatus.class}">${metrics.healthScore}</span>
                            </div>
                            <small class="text-muted">Health Score â€¢ ${healthStatus.label}</small>
                        </div>
                        <div class="card-body">
                            <!-- Health & Service Status -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Status</small>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-warning me-2">Standby</span>
                                        <span class="movement-indicator ${movementClass}" title="Movement cost: ${cost}"></span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Certification</small>
                                    <div>
                                        <span class="badge bg-${getFitnessBadgeColor(train)}">${getFitnessStatusText(train)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Main Health Score -->
                            <div class="text-center mb-3">
                                ${createHealthScoreGauge(metrics.healthScore)}
                                <small class="text-muted">Overall Health Score</small>
                            </div>
                            
                            <!-- Operational Metrics -->
                            <div class="operational-metrics">
                                <div class="row small">
                                    <div class="col-6">
                                        <span class="text-muted">Total Mileage:</span><br>
                                        <strong>${train.mileage.toLocaleString()} km</strong>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted">Cleaning:</span><br>
                                        <strong>${train.requires_cleaning ? 'Required' : 'Not Required'}</strong>
                                    </div>
                                </div>
                                <div class="row small mt-2">
                                    <div class="col-6">
                                        <span class="text-muted">Job Cards:</span><br>
                                        <strong>${train.job_cards.open_critical} critical</strong>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted">Stabling:</span><br>
                                        <strong>${train.current_stable_position}</strong>
                                    </div>
                                </div>
                            </div>
                            ${explHtml}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // Render IBL trains
            const iblContainer = document.getElementById('iblTrains');
            iblContainer.innerHTML = solution.ibl.map(train => {
                const metrics = calculateMaintenanceMetrics(train);
                const healthStatus = getHealthStatus(metrics.healthScore);
                const originalTrain = originalTrainData.find(t => t.id === train.id);
                const fromZone = originalTrain ? getZoneFromPosition(originalTrain.current_stable_position) : "Unknown";
                const cost = getMovementCost(fromZone, "IBL");
                let movementClass = "no-movement";
                if (cost === 2) movementClass = "low-movement";
                else if (cost >= 3) movementClass = "high-movement";

                const expl = Array.isArray(explanations[train.id]) ? explanations[train.id] : (explanations[train.id] ? [explanations[train.id]] : []);
                const explHtml = expl.length ? `<details><summary>Explanation</summary><ul class="explanation-list">${expl.map(e => `<li>${e}</li>`).join('')}</ul></details>` : '';

                return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card train-operational-card">
                        <div class="card-header bg-transparent border-bottom-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Train #${train.id.replace('T', '')}</h5>
                                <span class="badge bg-${healthStatus.class}">${metrics.healthScore}</span>
                            </div>
                            <small class="text-muted">Health Score â€¢ ${healthStatus.label}</small>
                        </div>
                        <div class="card-body">
                            <!-- Health & Service Status -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">Status</small>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-danger me-2">IBL</span>
                                        <span class="movement-indicator ${movementClass}" title="Movement cost: ${cost}"></span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Certification</small>
                                    <div>
                                        <span class="badge bg-${getFitnessBadgeColor(train)}">${getFitnessStatusText(train)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Main Health Score -->
                            <div class="text-center mb-3">
                                ${createHealthScoreGauge(metrics.healthScore)}
                                <small class="text-muted">Overall Health Score</small>
                            </div>
                            
                            <!-- Critical Issues -->
                            <div class="alert alert-warning small mb-3">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>${train.job_cards.open_critical} Critical Job Cards</strong>
                            </div>
                            
                            <!-- Operational Metrics -->
                            <div class="operational-metrics">
                                <div class="row small">
                                    <div class="col-6">
                                        <span class="text-muted">Total Mileage:</span><br>
                                        <strong>${train.mileage.toLocaleString()} km</strong>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted">Non-Critical:</span><br>
                                        <strong>${train.job_cards.open_non_critical} open</strong>
                                    </div>
                                </div>
                                <div class="row small mt-2">
                                    <div class="col-6">
                                        <span class="text-muted">Last Service:</span><br>
                                        <strong>${train.last_maintenance_date}</strong>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted">Stabling:</span><br>
                                        <strong>${train.current_stable_position}</strong>
                                    </div>
                                </div>
                            </div>
                            ${explHtml}
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // Show results section
            document.getElementById('optimizationResults').style.display = 'block';
        }

        // Run optimization - FIXED: Handle both conflict_alert and conflict fields
        async function runOptimization() {
            const btn = document.getElementById('runOptimization');
            const trainsRequired = parseInt(document.getElementById('trainsRequired').value || "0", 10);

            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Optimizing...';
            btn.disabled = true;

            try {
                const API_BASE = getApiBase();

                // Build the request payload and include branding_min_total if toggle enabled
                const payload = { required_trains: trainsRequired };

                const brandingEnabled = document.getElementById('brandingQuotaToggle').checked;
                if (brandingEnabled) {
                    const brandingValRaw = document.getElementById('brandingMinTotal').value;
                    if (brandingValRaw === null || String(brandingValRaw).trim() === '') {
                        showToast('Branding quota enabled but no value entered', 'warning');
                        btn.innerHTML = '<i class="fas fa-bolt me-2"></i>Run Optimization';
                        btn.disabled = false;
                        return;
                    }
                    const brandingVal = parseFloat(brandingValRaw);
                    if (Number.isNaN(brandingVal) || brandingVal < 0) {
                        showToast('branding_min_total must be a non-negative number', 'warning');
                        btn.innerHTML = '<i class="fas fa-bolt me-2"></i>Run Optimization';
                        btn.disabled = false;
                        return;
                    }
                    payload.branding_min_total = brandingVal;
                }

                const requestBody = JSON.stringify(payload);

                const response = await fetch(`${API_BASE}/optimize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: requestBody
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                logApiCall(`${API_BASE}/optimize`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: requestBody }, response, data);

                // FIXED: Handle both success status formats
                if (data.status === 'success' || data.solution) {
                    // Support both conflict_alert (old) and conflict (new) field names
                    const explanations = data.explanations || {};
                    let conflicts = data.conflict_alert || data.conflict || null;
                    if (typeof conflicts === 'string') conflicts = [conflicts];
                    
                    displayIntelligentTrainCards(data.solution, explanations, conflicts);
                    // Update ML insights
                    updateMLInsights(data.solution, explanations);
                    showToast('Optimization completed successfully', 'success');
                } else {
                    // If API returns error, show message
                    showToast('Error: ' + (data.message || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Full error details:', error);
                showToast(`Connection error: ${error.message}. Make sure the backend server is running on port 8000.`, 'danger');
            } finally {
                btn.innerHTML = '<i class="fas fa-bolt me-2"></i>Run Optimization';
                btn.disabled = false;
            }
        }

        // Navigate to scheduled.html
        function navigateToSchedule() {
            window.location.href = 'scheduled.html';
        }

        // Event listeners
        document.getElementById('runOptimization').addEventListener('click', runOptimization);
        document.getElementById('viewSchedule').addEventListener('click', navigateToSchedule);
        document.getElementById('setOverride').addEventListener('click', setOverride);
        document.getElementById('loadOverrides').addEventListener('click', loadOverrides);
        document.getElementById('showDebug').addEventListener('click', function() {
            document.getElementById('debugPanel').style.display = 'block';
            this.style.display = 'none';
            testConnection();
        });
        document.getElementById('toggleDebug').addEventListener('click', function() {
            document.getElementById('debugPanel').style.display = 'none';
            document.getElementById('showDebug').style.display = 'inline-block';
        });
        document.getElementById('testConnection').addEventListener('click', testConnection);
        document.getElementById('retrainModel').addEventListener('click', retrainMLModel);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadTrainData();
        });
    </script>
</body>
</html>